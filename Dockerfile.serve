# syntax=docker/dockerfile:1
FROM python:3.10-slim

# ------------------------------------------------------------------
# System dependencies
# ------------------------------------------------------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    bash \
    build-essential \
    git \
    curl \
    procps \
 && rm -rf /var/lib/apt/lists/*

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# ------------------------------------------------------------------
# Working directory (consistent with Airflow/MLflow paths)
# ------------------------------------------------------------------
WORKDIR /opt/airflow

# ------------------------------------------------------------------
# Python dependencies
# ------------------------------------------------------------------
COPY requirements.serve.txt .
RUN pip install --upgrade pip \
 && pip install --no-cache-dir -r requirements.serve.txt

# ------------------------------------------------------------------
# Entrypoint script
# ------------------------------------------------------------------
COPY entrypoint.sh /opt/airflow/entrypoint.sh
RUN chmod +x /opt/airflow/entrypoint.sh

# ------------------------------------------------------------------
# Runtime user (controlled via docker-compose `AIRFLOW_UID`)
# ------------------------------------------------------------------
USER ${AIRFLOW_UID:-1000}

# ------------------------------------------------------------------
# Ports & env defaults
# ------------------------------------------------------------------
EXPOSE 5001
ENV MODEL_NAME=loan_default_model \
    MODEL_ALIAS=staging \
    PORT=5001 \
    GOOGLE_APPLICATION_CREDENTIALS=/opt/airflow/keys/gcs-service-account.json

# ------------------------------------------------------------------
# Startup
# ------------------------------------------------------------------
ENTRYPOINT ["/opt/airflow/entrypoint.sh"]
